<template>
    <div class="chartmain">
        <!-- <div class="analytics-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ö–æ–∑—è–π—Å—Ç–≤ –∏ —Ä–µ–≥–∏–æ–Ω–æ–≤</div> -->
        <!-- <MainChart/> -->
        <div class="prev-chart" @click="toPrev" v-if="clickToPrev">ü†î –ù–∞–∑–∞–¥</div>
        <apexchart 
        id="analit_click" 
        width="860px"
        type="bar" 
        :options="optionsClick" 
        :series="seriesClick" 
        ref="analit"
        @dataPointSelection="clickHandler"
        ></apexchart>
        <div v-if="!clickToPrev" class="description">
            –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –∏–Ω–¥–µ–∫—Å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –ª—É—á—à–µ–π –∫–æ—Ä–æ–≤—ã (–ª—É—á—à–∞—è –∏–∑ –ª—É—á—à–∏—Ö) –∏ —Ö—É–¥—à–µ–π –∫–æ—Ä–æ–≤—ã (—Ö—É–¥—à–∞—è –∏–∑ —Ö—É–¥—à–∏—Ö) –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –≤—ã–≤–æ–¥–∏—Ç—Å—è —Ä–∞–∑–Ω–∏—Ü–∞ –¥–ª—è –∫–æ—Ä–æ–≤—ã, –∑–∞–º—ã–∫–∞—é—â–µ–π –ø–µ—Ä–≤—É—é –ø—è—Ç–µ—Ä–∫—É (—Ö—É–¥—à–µ–π –∏–∑ –ª—É—á—à–∏—Ö), –∏ –∫–æ—Ä–æ–≤—ã, –≤–æ–∑–≥–ª–∞–≤–ª—è—é—â–µ–π –ø–æ—Å–ª–µ–¥–Ω—é—é –ø—è—Ç–µ—Ä–∫—É (–ª—É—á—à–∞—è –∏–∑ —Ö—É–¥—à–∏—Ö).
            –ß–µ–º –Ω–∏–∂–µ –ø–æ–ª—É—á–∏–≤—à–∞—è—Å—è —Ä–∞–∑–Ω–∏—Ü–∞ - —Ç–µ–º –±–æ–ª–µ–µ –æ–¥–Ω–æ—Ä–æ–¥–Ω–æ–µ —Å—Ç–∞–¥–æ
        </div>
        <div v-else class="description">
            –ì—Ä–∞—Ñ–∏–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ –≥–æ–ª–æ–≤ –¥–ª—è —Ç—Ä–µ—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ —Å–µ–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ 33%, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≥—Ä—É–ø–ø–∞–º –¥–ª—è —Ö—É–¥—à–∏—Ö, —Å—Ä–µ–¥–Ω–∏—Ö –∏ –ª—É—á—à–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö
        </div>
    </div>
</template>

<script>
// import MainChart from '@/components/analyticsComponents/MainChart.vue';

export default {
    components: {
        // MainChart
    },
    data() {
        return {
            optionsClick: {
                chart: {
                    id: 'analit_click',
                    stacked: false,
                    zoom: {
                        enabled: false,
                    },
                },
                xaxis: {
                    categories: [],
                    dataLabels: {
                        enabled: true,
                        style: {
                            fontSize: '10px',
                        }
                    },
                    labels: {
                        style: {
                            fontSize: '10px',
                        },
                        hideOverlappingLabels: true,
                        trim: true,
                    }
                },

                colors: ['#78DABC','#6e5add','#75a2e7'],
                title: {
                    text: '–†–∞–∑–Ω–∏—Ü–∞ –∏–Ω–¥–µ–∫—Å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –º–µ–∂–¥—É 5 –ª—É—á—à–∏–º–∏ –∏ 5 —Ö—É–¥—à–∏–º–∏ –∫–æ—Ä–æ–≤–∞–º–∏',
                    align: 'center',
                    style: {
                        fontSize:  '15px',
                    },
                },
                tooltip: {
                    x: {
                        show: false,
                    }
                }
            },
            seriesClick: [],
            
            newX: [],
            result: [],
            clickToPrev: false,
            currHoz: {},
        }
    },
    async mounted() {
        this.seriesClick = [];
        let response = await fetch('/api/analitics/total/23/regionalStatistics/');
        this.result = await response.json();
        this.chooseChart();
        console.log(this.newX, 'mounted')
    },
    methods: {
        toPrev() {
            this.$router.back();
        },
        async clickHandler(event, chartContext, config) {
            if (this.$route.query.hoz) {
                let currAnim = [];
                if (config.dataPointIndex === 0) currAnim = this.currHoz.MinCowIds;
                else if (config.dataPointIndex === 1) currAnim = this.currHoz.AvgCowIds;
                else if (config.dataPointIndex == 2) currAnim = this.currHoz.MaxCowIds;
                this.$store.commit('SET_CURRENTANIMALS', currAnim);
                this.$router.push('/animals');
            } else {
                let hoz = {};
                for (let i = 0; i < this.result.length; i++) {
                    if(this.result[i].Farm) {
                        if(this.result[i].Farm.Name == this.newX[config.dataPointIndex]) {
                            hoz = this.result[i];
                        }
                    } else {
                        if (this.newX[config.dataPointIndex] == '–í–µ—Å—å —Ä–µ–≥–∏–æ–Ω') {
                            hoz = this.result[i];
                        }
                    }
                }
                await this.$router.push({query: {hoz: hoz.ID.toString()}});
            }
        },
        chooseChart() {
            let q = this.$route.query;
            if (q.hoz) {
                for (let i = 0; i < this.result.length; i++) {
                    if (this.result[i].ID == q.hoz) {
                        this.clickToPrev = true;
                        this.seriesClick = [{data: [], name: '–•—É–¥—à–∏–µ'}, {data: [], name: '–°—Ä–µ–¥–Ω–∏–µ'}, {data: [], name:'–õ—É—á—à–∏–µ'}];
                        let currentHoz = this.result[i];
                        this.currHoz = this.result[i];
                        this.seriesClick[0].data.push(
                            currentHoz.MinCount
                        );
                        this.seriesClick[1].data.push(
                            currentHoz.AvgCount
                        );
                        this.seriesClick[2].data.push(
                            currentHoz.MaxCount
                        );
                        
                        this.$refs.analit.updateOptions({
                            xaxis: {
                                categories: [0],
                                labels: {
                                    show: false,
                                },
                                title: {
                                    text: '–°–µ–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å',
                                }
                            },
                            yaxis: {
                                title: {
                                    text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ–≤ –ö–†–°',
                                }
                            },
                            legend: {
                                show: false,
                            }
                        });

                        let newtitle;
                        if (currentHoz.Farm) {
                            newtitle = ['–ß–∏—Å–ª–æ –≥–æ–ª–æ–≤ –≤ ', currentHoz.Farm.Name];
                        } else {
                            newtitle = '–ß–∏—Å–ª–æ –≥–æ–ª–æ–≤ –≤–æ –≤—Å–µ–º —Ä–µ–≥–∏–æ–Ω–µ';
                        }
                        this.$refs.analit.updateOptions({
                            title: {
                                text: newtitle
                            }
                        });
                        return
                    }
                }
            } else {
                this.clickToPrev = false;
                this.seriesClick = [];
                this.newX = []; 
                let newY = {name: '–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ª—É—á—à–µ–π –∏–∑ –ª—É—á—à–∏—Ö –∏ —Ö—É–¥—à–µ–π –∏–∑ —Ö—É–¥—à–∏—Ö', data: []};
                // let index;
                for (let i = 0; i < this.result.length; i++) {
                    if (this.result[i].Farm) {
                        this.newX.push(this.result[i].Farm.Name);
                        newY.data.push(this.result[i].MaxIndex);
                    } else {
                        // index = i;
                    }
                }
                // this.newX.push('–í–µ—Å—å —Ä–µ–≥–∏–æ–Ω');
                // newY.data.push(this.result[index].MaxIndex);
                this.seriesClick.push(newY);
                this.seriesClick.push( {name: '–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ö—É–¥—à–µ–π –∏–∑ –ª—É—á—à–∏—Ö –∏ –ª—É—á—à–µ–π –∏–∑ —Ö—É–¥—à–∏—Ö',data: [245.57, 273.36, 292.52, 307.85, 375.19, 406.50, 418.41]});

                this.$refs.analit.updateOptions({
                    xaxis: {
                        categories: this.newX,
                        labels: {
                            show: true,
                        },
                        title: {
                            text: ' ',
                        }
                    },
                    yaxis: {
                        title: {
                            text: ' ',
                        }
                    }
                });

                this.$refs.analit.updateOptions({
                    title: {
                        text: '–†–∞–∑–Ω–∏—Ü–∞ –∏–Ω–¥–µ–∫—Å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –º–µ–∂–¥—É 5 –ª—É—á—à–∏–º–∏ –∏ 5 —Ö—É–¥—à–∏–º–∏ –∫–æ—Ä–æ–≤–∞–º–∏'
                    }
                });
            }
        },
    },
    watch: {
        $route() {
            this.chooseChart();
        }
    },

}
</script>

<style scoped>
.prev-chart {
    font-family: Open Sans, sans-serif;
    margin-top: 30px;
    margin-left: 20px;
    color:rgb(10, 113, 75);
    padding-bottom: 20px;
    cursor: pointer;
    transition: 0.3s;
    justify-self: flex-start;
    align-self: flex-start;
}

.prev-chart:hover {
    color: rgb(63, 205, 120);
    padding-left: 10px;
    width: max-content;
}

.description {
    font-family: Open Sans, sans-serif;
    margin-top: 10px;
    text-align: center;
    color: rgb(90, 90, 90);
}

.chartmain {
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-items: center;
    align-items: center;
}
</style>